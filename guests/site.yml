---
- hosts: all
  gather_facts: no

  tasks:

    # Bootstrap Ansible itself
    - include: tasks/bootstrap.yml

- hosts: all

  vars_files:
    - vars/mappings.yml

  tasks:

    # Prepare environment. None of the actions performed here might
    # depend on packages being installed
    - include: tasks/base.yml
    - include: tasks/compat.yml

    # Install base packages
    - include: tasks/packages.yml
      vars:
        project: base

    # Create users. This needs to happen after installing base packages
    - include: tasks/user.yml

    # Install build dependencies for each project
    - include: tasks/packages.yml
      with_items:
        '{{ projects }}'
      loop_control:
        loop_var: project
      when:
        - projects is defined

    # Install packages needed for the Jenkins agent
    - include: tasks/packages.yml
      vars:
        project: jenkins
      when:
        - flavor == "jenkins"

    # Configure the Jenkins agent
    - include: tasks/jenkins.yml
      when:
        - flavor == 'jenkins'
