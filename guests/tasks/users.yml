---
- name: 'root: Set password'
  user:
    name: root
    password: '{{ lookup("file", root_password_file) }}'
    shell: '{{ bash }}'

- name: 'root: Configure ssh access'
  authorized_key:
    user: root
    key: '{{ lookup("file", lookup("env", "HOME") + "/.ssh/id_rsa.pub") }}'
    state: present

- name: 'root: Disable ssh password authentication'
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#*\s*PermitRootLogin\s*.*$'
    line: 'PermitRootLogin without-password'
    state: present
    backup: yes

- name: '{{ flavor }}: Create user account'
  user:
    name: '{{ flavor }}'
    comment: '{{ flavor }}'
    password: '*'
    shell: '{{ bash }}'

- name: '{{ flavor }}: Set password'
  user:
    name: '{{ flavor }}'
    password: '$6$xSlfvkcsDgPmRAMX$mFh9qRmFFW9cyW1n5/jeHvq4OmJA8WzSD70Mfis3VHc3Z5imZeiQAg9VNL4sFEtmDy/siU3nJL.QeAapCgfL20'
  when:
    - flavor == 'test'

- name: '{{ flavor }}: Configure ssh access'
  authorized_key:
    user: '{{ flavor }}'
    key: '{{ lookup("file", lookup("env", "HOME") + "/.ssh/id_rsa.pub") }}'
    state: present
  when:
    - flavor == 'test'

- name: '{{ flavor }}: Grant passwordless sudo access'
  lineinfile:
    path: '{{ sudoers }}'
    line: '{{ flavor }} ALL=(ALL) NOPASSWD: ALL'
    state: present
    backup: yes
    validate: 'visudo -cf %s'
  when:
    - flavor == 'test'

- name: '{{ flavor }}: Configure ccache'
  file:
    path: /home/{{ flavor }}/.ccache
    state: directory
    owner: '{{ flavor }}'
    group: '{{ flavor }}'

- name: '{{ flavor }}: Configure ccache'
  copy:
    src: files/ccache.conf
    dest: /home/{{ flavor }}/.ccache/ccache.conf
    owner: '{{ flavor }}'
    group: '{{ flavor }}'

- name: '{{ flavor }}: Enable ccache'
  lineinfile:
    path: /home/{{ flavor }}/.profile
    line: 'which ccache >/dev/null 2>&1 && export CC="ccache cc"'
    state: present
    owner: '{{ flavor }}'
    group: '{{ flavor }}'
    create: yes

- name: '{{ flavor }}: Enable ccache'
  lineinfile:
    path: /home/{{ flavor }}/.bashrc
    line: 'which ccache >/dev/null 2>&1 && export CC="ccache cc"'
    state: present
    owner: '{{ flavor }}'
    group: '{{ flavor }}'
    create: yes

- name: '{{ flavor }}: Create shell profile'
  template:
    src: templates/{{ item }}
    dest: /home/{{ flavor }}/.{{ item }}
    owner: '{{ flavor }}'
    group: '{{ flavor }}'
  with_items:
    - bash_profile
    - bashrc

- name: '{{ flavor }}: Remove existing shell profile'
  file:
    path: /home/{{ flavor }}/.{{ item }}
    state: absent
  with_items:
    - profile
